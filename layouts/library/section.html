{{ define "main" }}

{{ $isLibraryHome := eq .RelPermalink "/library/" }}
{{ $books := .RegularPages }}
{{ if $isLibraryHome }}
    {{ $sections := (sort .Sections) | collections.Reverse }}
    {{ range $sections }}
        {{ $books = $books | append .RegularPages }}
    {{ end }}
{{ end }}

{{ $years := slice }}
{{ range .Sections }}
    {{ $years = $years | append .Title }}
{{ end }}
{{ $years = $years | collections.Reverse }}

  <article class="pagefind-exclude">
    {{ partial "header.html" . }}
    {{ partial "home/home-nav" . }}

    <div class="markdown-body">{{ .Content }}</div>

    <div>

        {{ if $isLibraryHome }}
        {{ partial "components/section-title" (dict
            "Left" "最近读的书"
            "Right" (printf "共 %d 篇书评" (len $books))
        )}}
        {{ end }}

        <div class="grid grid-cols-4 md:grid-cols-6 items-center gap-4 my-4">
            {{ $booksToShow := $books }}
            {{ if $isLibraryHome }}
                {{ $booksToShow = first 18 $books }}
            {{ end }}
            {{ range $i, $book := $booksToShow }}
                <div class="{{ if gt $i 15 }}hidden md:block{{ end }}">
                    {{ partial "items/book" (dict
                        "ctx" $book
                    ) }}
                </div>
            {{ end }}
        </div>


        <!-- ONLY SHOW IN HOME SECTION / START -->
        {{ if $isLibraryHome }}

        <!-- === year list === -->
        <div class="flex items-center my-8 justify-between gap-4">
          <a href="/library/{{ now.Year }}" class="small-button">
                {{ T "library.viewAllThisYear" }}
                <span class="text-secondary">→</span>
            </a>
            <p class="my-0">
              {{ $currentYear := printf "%d" now.Year }}
              {{ range $i, $year := $years }}
                {{ if ne $year $currentYear }}
                  <a class="text-secondary" href="{{ printf "/library/%s/" $year }}">{{ $year }} 年</a>
                  {{ if not (eq $i (sub (len $years) 1)) }}·{{ end }}
                {{ end }}
              {{ end }}
            </p>
        </div>

        <!-- === good books section === -->
        {{ $goodBooks := where $books ".Params.rating" "==" 5 }}
        {{ partial "components/section-title" (dict
            "Left" "推荐好书"
            "Right" (printf "共 %d 本" (len $goodBooks))
        )}}
        <div class="grid grid-cols-4 md:grid-cols-6 items-center gap-4 my-4">
        {{ range $goodBooks }}
            {{ partial "items/book" (dict
                "ctx" .
                "NoViewTransition" true
            ) }}
        {{ end }}
        </div>

        {{ end }}
        <!-- ONLY SHOW IN HOME SECTION / END -->

    </div>
  </article>
  {{ partial "footer.html" . }}
{{ end }}
